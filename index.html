<!DOCTYPE html>
<html>
<head>
  <title>Kenya eTIMS Compliance</title>
  <script>
    // Context injected by Manager.io
    const { apiEndpoint, apiAccessToken, businessId } = window.managerAppContext;

    async function transmitToKRA(invoiceData) {
      // Call your backend (or direct OSCU if keys stored securely)
      const res = await fetch('/api/transmit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(invoiceData)
      });
      return res.json();
    }

    async function onInvoiceLoad() {
      // Example: Fetch current invoice via API
      const invoice = await fetch(`${apiEndpoint}/sales-invoices/current`, {
        headers: { Authorization: `Bearer ${apiAccessToken}` }
      }).then(r => r.json());

      // Add QR after transmission
      const kraResponse = await transmitToKRA(invoice);
      if (kraResponse.qrData) {
        const qrImg = await QRCode.toDataURL(kraResponse.qrData);
        document.getElementById('qr-container').innerHTML = `<img src="${qrImg}">`;
      }
    }

    window.onload = onInvoiceLoad;
  </script>
</head>
<body>
  <h3>Kenya eTIMS Status</h3>
  <div id="qr-container">Transmitting...</div>
  <button onclick="onInvoiceLoad()">Retry Transmit</button>
</body>
</html>
